<!doctype html>
<!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="{{ html_lang }}" {{ html_lang_dir }}> <![endif]-->
<!--[if IE 7]>    <html class="no-js lt-ie9 lt-ie8" lang="{{ html_lang }}" {{ html_lang_dir }}>        <![endif]-->
<!--[if IE 8]>    <html class="no-js lt-ie9" lang="{{ html_lang }}" {{ html_lang_dir }}>               <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="{{ html_lang }}" {{ html_lang_dir }}>              <!--<![endif]-->
  <head>
    <meta charset="utf-8">
    <title>{{ page_meta.html_title }}</title>
    {% if site_settings.favicon_src %}<link rel="shortcut icon" href="{{ site_settings.favicon_src }}" />{% endif %}
    <meta name="description" content="{{ page_meta.meta_description }}">
    {{ standard_header_includes }}

    <!-- Google Fonts preconnect for performance -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <!-- Theme CSS -->
    <link rel="stylesheet" href="{{ get_asset_url('../css/shared-variables.css') }}" media="all">
    <link rel="stylesheet" href="{{ get_asset_url('../css/cellcolabsclinical-theme-variables.css') }}" media="all">
    <link rel="stylesheet" href="{{ get_asset_url('../css/main.css') }}" media="all">

    <!-- CSS loading validation only -->
    <style>
      /* Minimal fallback only for CSS loading validation */
      .css-test {
        font-family: 'Inter', sans-serif;
      }
    </style>

    <!-- Brand Detection and Application -->
    <script>
      (function() {
        // Detect brand based on domain
        var hostname = window.location.hostname;
        var brand = 'cellcolabs'; // Default brand

        if (hostname.includes('cellcolabsclinical')) {
          brand = 'cellcolabsclinical';
        }

        // Apply brand as data attribute and class
        document.documentElement.setAttribute('data-brand', brand);
        document.documentElement.className += ' brand-' + brand;

        // Store in localStorage for persistence
        localStorage.setItem('active-brand', brand);
      })();
    </script>

    <!-- HubSpot Theme Settings -->
    {% if theme.brand_settings.active_brand %}
      <script>
        document.documentElement.setAttribute('data-brand', '{{ theme.brand_settings.active_brand }}');
        document.documentElement.className += ' brand-{{ theme.brand_settings.active_brand }}';
      </script>
    {% endif %}
  </head>

  <body>

    <!-- Header -->
    <header class="site-header">
      <!-- Navigation -->
      <nav class="site-navigation" data-brand="cellcolabsclinical">
        <div class="nav-container">
          <div class="nav-wrapper">
            <!-- Logo -->
            <a href="/" class="nav-logo">
              <!-- Desktop Text Logo -->
              <span class="nav-logo-text nav-logo-desktop">
                <span class="nav-logo-bold">Cellcolabs</span>
                <span class="nav-logo-light">Clinical</span>
              </span>
              <!-- Mobile/Tablet Logo Image -->
              <img src="https://144549987.fs1.hubspotusercontent-eu1.net/hubfs/144549987/Cellcolabs%20Clinical%20Logo.png" alt="Cellcolabs Clinical" class="nav-logo-image-mobile nav-logo-mobile">
            </a>

            <!-- Desktop Menu -->
            <div class="nav-menu-desktop">
              {% menu "main_navigation"
                id="main_navigation",
                site_map_name="main_navigation",
                overrideable=False,
                root_type="site_root",
                flyouts="true",
                max_levels="2",
                flow="horizontal",
                menu_class="nav-menu-list",
                item_class="nav-menu-item",
                link_class="nav-menu-link",
                active_class="nav-menu-item--active",
                child_ul_class="nav-submenu",
                child_li_class="nav-submenu-item",
                child_a_class="nav-submenu-link"
              %}
            </div>

            <!-- Mobile Menu Button -->
            <button class="nav-toggle" aria-label="Toggle navigation" aria-expanded="false">
              <svg class="nav-toggle-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <circle cx="4" cy="4" r="1.5" fill="currentColor"/>
                <circle cx="12" cy="4" r="1.5" fill="currentColor"/>
                <circle cx="20" cy="4" r="1.5" fill="currentColor"/>
                <circle cx="4" cy="12" r="1.5" fill="currentColor"/>
                <circle cx="12" cy="12" r="1.5" fill="currentColor"/>
                <circle cx="20" cy="12" r="1.5" fill="currentColor"/>
                <circle cx="4" cy="20" r="1.5" fill="currentColor"/>
                <circle cx="12" cy="20" r="1.5" fill="currentColor"/>
                <circle cx="20" cy="20" r="1.5" fill="currentColor"/>
              </svg>
              <svg class="nav-toggle-close" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                <path d="M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
            </button>
          </div>
        </div>

        <!-- Mobile Menu -->
        <div class="nav-menu-mobile">
          <div class="nav-menu-mobile-wrapper">
            {% menu "main_navigation_mobile"
              id="main_navigation",
              site_map_name="main_navigation",
              overrideable=False,
              root_type="site_root",
              flyouts="false",
              max_levels="2",
              flow="vertical",
              menu_class="nav-mobile-list",
              item_class="nav-mobile-item",
              link_class="nav-mobile-link",
              active_class="nav-mobile-item--active",
              child_ul_class="nav-mobile-submenu",
              child_li_class="nav-mobile-submenu-item",
              child_a_class="nav-mobile-submenu-link"
            %}
          </div>
        </div>

        <!-- Mobile Divider -->
        <div class="nav-divider-mobile"></div>
      </nav>
    </header>

    <!-- Main Content -->
    <main class="main-content">
      {% block body %}
      {% endblock body %}
    </main>

    <!-- Footer -->
    <footer class="site-footer">
      <div class="container">
        <p>&copy; {{ current_year }} Cellcolabs Clinical. All rights reserved.</p>
      </div>
    </footer>

    {{ standard_footer_includes }}

    <!-- Custom Scripts -->
    <script>
      // Theme switcher for development/preview
      if (window.location.search.includes('theme=')) {
        const urlParams = new URLSearchParams(window.location.search);
        const theme = urlParams.get('theme');
        if (theme === 'cellcolabs' || theme === 'cellcolabsclinical') {
          document.documentElement.setAttribute('data-brand', theme);
          document.documentElement.className = document.documentElement.className.replace(/brand-\w+/, 'brand-' + theme);
        }
      }

      // CSS Loading Validation
      document.addEventListener('DOMContentLoaded', function() {
        // Check if main CSS loaded properly
        const testElement = document.createElement('div');
        testElement.className = 'css-test';
        testElement.style.display = 'none';
        document.body.appendChild(testElement);

        const computedStyle = window.getComputedStyle(testElement);
        const cssLoaded = computedStyle.fontFamily && computedStyle.fontFamily.includes('Inter');

        if (!cssLoaded) {
          console.warn('Main CSS failed to load, applying fallback styles');
          // Apply minimal fallback styles
          document.documentElement.style.setProperty('--font-body', 'Inter, sans-serif');
          document.documentElement.style.setProperty('--color-text-primary', '#161616');
          document.documentElement.style.setProperty('--color-bg-primary', '#ffffff');
        } else {
          console.log('✅ Main CSS loaded successfully');
        }

        document.body.removeChild(testElement);

        // Validate sticky header CSS
        const header = document.querySelector('.site-header');
        if (header) {
          const headerStyle = window.getComputedStyle(header);
          if (headerStyle.position === 'sticky' || headerStyle.position === '-webkit-sticky') {
            console.log('✅ Sticky header CSS applied successfully');
          } else {
            console.warn('❌ Sticky header CSS not applied, position:', headerStyle.position);
          }
        }
      });

      // Navigation JavaScript
      (function() {
        // Simpler scroll detection for visual feedback
        const header = document.querySelector('.site-header');
        if (header) {
          let lastScroll = 0;

          function handleScroll() {
            const currentScroll = window.pageYOffset || document.documentElement.scrollTop;

            // Add/remove scrolled class for visual feedback
            if (currentScroll > 10) {
              header.classList.add('is-scrolled');
            } else {
              header.classList.remove('is-scrolled');
            }

            lastScroll = currentScroll;
          }

          // Throttle scroll events for better performance
          let scrollTimer;
          window.addEventListener('scroll', function() {
            if (scrollTimer) {
              clearTimeout(scrollTimer);
            }
            scrollTimer = setTimeout(handleScroll, 10);
          }, { passive: true });

          // Run once on load
          handleScroll();
        }

        // Mobile menu toggle
        const navToggle = document.querySelector('.nav-toggle');
        const navMobile = document.querySelector('.nav-menu-mobile');

        if (navToggle && navMobile) {
          navToggle.addEventListener('click', function() {
            const isExpanded = this.getAttribute('aria-expanded') === 'true';
            this.setAttribute('aria-expanded', !isExpanded);
            navMobile.classList.toggle('is-active');
            document.body.style.overflow = !isExpanded ? 'hidden' : '';
          });
        }

        // Close mobile menu on escape key
        document.addEventListener('keydown', function(e) {
          if (e.key === 'Escape' && navMobile && navMobile.classList.contains('is-active')) {
            navToggle.setAttribute('aria-expanded', 'false');
            navMobile.classList.remove('is-active');
            document.body.style.overflow = '';
          }
        });

        // Close mobile menu on click outside
        document.addEventListener('click', function(e) {
          if (navMobile && navMobile.classList.contains('is-active')) {
            if (!e.target.closest('.site-navigation')) {
              navToggle.setAttribute('aria-expanded', 'false');
              navMobile.classList.remove('is-active');
              document.body.style.overflow = '';
            }
          }
        });
      })();
    </script>
  </body>
</html>