<!--
  templateType: module
  label: Article with Table of Contents
  isAvailableForNewContent: true
-->

<style>
  /* Article with TOC Module - Uses Brand CSS Variables */

  .article-with-toc {
    display: flex;
    gap: var(--space-16, 16px);
    width: 100%;
    max-width: var(--content-max-width, 1400px);
    margin: 0 auto;
    padding: 0;
  }

  /* Table of Contents - Left Column */
  .article-toc {
    flex: 0 0 calc(50% - 8px);
    padding-top: 0; /* Spacing controlled by DND section container */
    padding-bottom: 0;
  }

  .article-toc__sticky {
    position: sticky;
    top: 128px;
    display: flex;
    flex-direction: column;
    gap: var(--space-4, 4px);
  }

  .article-toc__link {
    font-family: var(--font-body, 'Inter', sans-serif) !important;
    font-size: var(--font-size-body, 16px) !important;
    font-weight: var(--font-weight-regular, 400) !important;
    line-height: 1.35 !important;
    color: var(--color-text-tertiary, #8d8d8d) !important;
    text-decoration: none !important;
    cursor: pointer;
    transition: color 0.2s ease;
    display: block !important;
    padding: var(--space-4, 4px) 0 !important;
    background: none !important;
    border: none !important;
    border-radius: 0 !important;
    text-align: left !important;
    width: auto !important;
  }

  .article-toc__link:hover {
    color: var(--color-text-secondary, #525252) !important;
    background: none !important;
  }

  .article-toc__link.is-active {
    color: var(--color-text-primary, #161616) !important;
    font-weight: 500 !important;
    background: none !important;
  }

  /* Additional specificity to override Growth theme link and button styles */
  .article-toc a.article-toc__link.button,
  .article-toc a.article-toc__link.button:visited {
    color: var(--color-text-tertiary, #8d8d8d) !important;
    text-decoration: none !important;
    background: none !important;
    border: none !important;
  }

  .article-toc a.article-toc__link.button:hover {
    color: var(--color-text-secondary, #525252) !important;
    background: none !important;
  }

  .article-toc a.article-toc__link.button.is-active {
    color: var(--color-text-primary, #161616) !important;
    background: none !important;
  }

  /* Article Content - Right Column */
  .article-content {
    flex: 0 0 calc(50% - 8px);
    padding-top: 0; /* Spacing controlled by DND section container */
    padding-bottom: 0; /* Spacing controlled by DND section container */
  }

  .article-content__sections {
    display: flex;
    flex-direction: column;
    gap: var(--space-64, 64px);
  }

  .article-section {
    /* scroll-margin handled by JavaScript scroll offset */
  }

  .article-references {
    /* scroll-margin handled by JavaScript scroll offset */
  }

  .article-section__heading {
    font-family: var(--font-heading, 'Inter', sans-serif);
    font-size: 28px;
    font-weight: 580;
    line-height: 1.15;
    color: var(--color-text-primary, #161616);
    margin: 0 0 var(--space-16, 16px) 0;
  }

  .article-section__content {
    font-family: var(--font-body, 'Inter', sans-serif);
    font-size: var(--font-size-body, 16px);
    font-weight: var(--font-weight-regular, 400);
    line-height: 1.35;
    color: var(--color-text-secondary, #525252);
  }

  .article-section__content p {
    margin: 0 0 var(--space-16, 16px) 0;
  }

  .article-section__content p:last-child {
    margin-bottom: 0;
  }

  .article-section__content ul,
  .article-section__content ol {
    margin: 0 0 var(--space-16, 16px) 0;
    padding-left: var(--space-24, 24px);
  }

  .article-section__content li {
    margin-bottom: var(--space-4, 4px);
  }

  .article-section__content li:last-child {
    margin-bottom: 0;
  }

  .article-section__content a {
    color: var(--color-text-link, #4F65BE);
    text-decoration: underline;
  }

  .article-section__content a:hover {
    color: var(--color-primary, #4F65BE);
  }

  .article-section__image {
    margin-top: var(--space-48, 48px);
    border-radius: var(--border-radius-lg, 16px);
    overflow: hidden;
  }

  .article-section__image img {
    width: 100%;
    height: auto;
    display: block;
  }

  /* References Section */
  .article-references {
    margin-top: var(--space-64, 64px);
  }

  .article-references__toggle,
  button.article-references__toggle,
  .article-references button.article-references__toggle {
    background-color: var(--color-gray-900, #F4F4F4) !important;
    background-image: none !important;
    border: none !important;
    border-radius: var(--border-radius-md, 8px) !important;
    padding: var(--space-12, 12px) var(--space-16, 16px) var(--space-12, 12px) var(--space-24, 24px) !important;
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: space-between;
    cursor: pointer;
    transition: background-color 0.2s ease;
    text-align: left;
  }

  .article-references__toggle:hover,
  button.article-references__toggle:hover,
  .article-references button.article-references__toggle:hover {
    background-color: var(--color-gray-800, #E0E0E0) !important;
    background-image: none !important;
  }

  .article-references__title {
    font-family: var(--font-body, 'Inter', sans-serif);
    font-size: var(--font-size-body, 16px);
    font-weight: 550;
    line-height: 1.15;
    color: var(--color-text-primary, #161616);
    margin: 0;
    flex: 1;
  }

  .article-references__icon {
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    margin-left: var(--space-8, 8px);
  }

  .article-references__icon svg {
    width: 18px;
    height: 18px;
    display: block;
  }

  .article-references__icon--plus {
    display: block !important;
  }

  .article-references__icon--minus {
    display: none !important;
  }

  .article-references.is-open .article-references__icon--plus {
    display: none !important;
  }

  .article-references.is-open .article-references__icon--minus {
    display: block !important;
  }

  .article-references__content {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease;
  }

  .article-references.is-open .article-references__content {
    max-height: 2000px;
  }

  .article-references__content-inner {
    padding: var(--space-16, 16px) var(--space-24, 24px);
    font-family: var(--font-body, 'Inter', sans-serif);
    font-size: var(--font-size-body-small, 14px);
    line-height: 1.5;
    color: var(--color-text-secondary, #525252);
  }

  .article-references__content-inner p {
    margin: 0 0 var(--space-8, 8px) 0;
  }

  .article-references__content-inner p:last-child {
    margin-bottom: 0;
  }

  /* Mobile Layout (767px and below) */
  @media (max-width: 767px) {
    .article-with-toc {
      flex-direction: column;
      gap: 0;
      padding: 0; /* Spacing controlled by DND section container */
      position: relative;
    }

    .article-toc {
      flex: none;
      padding: 0;
      position: static;
      width: 100%;
      padding-bottom: var(--space-16, 16px);
      margin-bottom: var(--space-32, 32px);
    }

    .article-toc__sticky {
      position: static;
      flex-direction: column;
      gap: var(--space-4, 4px);
    }

    .article-toc__link {
      font-size: var(--font-size-body-small, 14px) !important;
      padding: var(--space-4, 4px) 0 !important;
    }

    .article-toc__link.is-active {
      color: var(--color-text-primary, #161616) !important;
    }

    .article-content {
      flex: none;
      padding: 0; /* Spacing controlled by DND section container */
    }

    .article-section__heading {
      font-size: 24px;
    }

    .article-content__sections {
      gap: var(--space-48, 48px);
    }

    /* Scroll margins handled by JavaScript */
  }

  /* Tablet Layout (768px-1023px) */
  @media (max-width: 1023px) and (min-width: 768px) {
    .article-toc {
      padding-top: 0; /* Spacing controlled by DND section container */
    }

    .article-toc__sticky {
      top: 96px;
    }

    .article-content {
      padding-top: 0; /* Spacing controlled by DND section container */
      padding-bottom: 0; /* Spacing controlled by DND section container */
    }

    .article-section__heading {
      font-size: 24px;
    }

    /* Scroll margins handled by JavaScript */
  }
</style>

<div class="article-with-toc">
  <!-- Table of Contents -->
  <div class="article-toc">
    <nav class="article-toc__sticky" role="navigation" aria-label="Table of Contents">
      {% for section in module.article_sections %}
        <a
          href="#section-{{ loop.index }}"
          class="article-toc__link button"
          data-toc-link
          data-section-id="section-{{ loop.index }}"
        >
          {{ section.section_title }}
        </a>
      {% endfor %}
      {% if module.show_references %}
        <a
          href="#references"
          class="article-toc__link button"
          data-toc-link
          data-section-id="references"
        >
          References
        </a>
      {% endif %}
    </nav>
  </div>

  <!-- Article Content -->
  <div class="article-content">
    <div class="article-content__sections">
      {% for section in module.article_sections %}
        <section class="article-section" id="section-{{ loop.index }}" data-section>
          <h3 class="article-section__heading">{{ section.section_title }}</h3>
          {% if section.section_content %}
            <div class="article-section__content">
              {{ section.section_content }}
            </div>
          {% endif %}
          {% if section.section_image.src %}
            <div class="article-section__image">
              <img
                src="{{ section.section_image.src }}"
                alt="{{ section.section_image.alt }}"
                loading="lazy"
              />
            </div>
          {% endif %}
        </section>
      {% endfor %}

      {% if module.show_references %}
        <div class="article-references" id="references" data-section>
          <button class="article-references__toggle" data-references-toggle>
            <h4 class="article-references__title">References</h4>
            <div class="article-references__icon">
              <!-- Plus Icon (collapsed) - 5-dot cross pattern -->
              <svg class="article-references__icon--plus" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
                <circle cx="3" cy="9" r="1.5" fill="#161616"/>
                <circle cx="9" cy="3" r="1.5" fill="#161616"/>
                <circle cx="9" cy="9" r="1.5" fill="#161616"/>
                <circle cx="9" cy="15" r="1.5" fill="#161616"/>
                <circle cx="15" cy="9" r="1.5" fill="#161616"/>
              </svg>
              <!-- Minus Icon (expanded) - 3-dot horizontal line -->
              <svg class="article-references__icon--minus" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
                <circle cx="3" cy="9" r="1.5" fill="#161616"/>
                <circle cx="9" cy="9" r="1.5" fill="#161616"/>
                <circle cx="15" cy="9" r="1.5" fill="#161616"/>
              </svg>
            </div>
          </button>
          <div class="article-references__content" data-references-content>
            <div class="article-references__content-inner">
              {{ module.references_content }}
            </div>
          </div>
        </div>
      {% endif %}
    </div>
  </div>
</div>

<script>
  (function() {
    function initArticleWithTOC() {
      const tocLinks = document.querySelectorAll('[data-toc-link]');
      const sections = document.querySelectorAll('[data-section]');
      const referencesToggle = document.querySelector('[data-references-toggle]');
      const referencesSection = document.querySelector('.article-references');

      if (tocLinks.length === 0 || sections.length === 0) return;

      // Scroll spy - DISABLED for mobile (all links remain in inactive state)
      // function updateActiveTOCLink() {
      //   const scrollPosition = window.scrollY + 100; // Offset for better UX
      //
      //   let currentSection = null;
      //
      //   sections.forEach(section => {
      //     const sectionTop = section.offsetTop;
      //     const sectionBottom = sectionTop + section.offsetHeight;
      //
      //     if (scrollPosition >= sectionTop && scrollPosition < sectionBottom) {
      //       currentSection = section.id;
      //     }
      //   });
      //
      //   // Update active state on TOC links
      //   tocLinks.forEach(link => {
      //     const sectionId = link.getAttribute('data-section-id');
      //     if (sectionId === currentSection) {
      //       link.classList.add('is-active');
      //     } else {
      //       link.classList.remove('is-active');
      //     }
      //   });
      // }

      // Smooth scroll to section on TOC link click
      tocLinks.forEach(link => {
        link.addEventListener('click', function(e) {
          e.preventDefault();
          const sectionId = this.getAttribute('data-section-id');
          const targetSection = document.getElementById(sectionId);

          if (targetSection) {
            const isMobile = window.innerWidth <= 767;
            const isTablet = window.innerWidth >= 768 && window.innerWidth <= 1023;

            if (isMobile) {
              // Mobile: Use getBoundingClientRect for accurate positioning
              const tocElement = document.querySelector('.article-toc');
              const stickyTopPosition = 72; // Where TOC sticks (top: 72px in CSS)
              const tocHeight = tocElement ? tocElement.offsetHeight : 0;

              // Get current position of section relative to viewport
              const sectionRect = targetSection.getBoundingClientRect();
              const currentScrollY = window.scrollY || window.pageYOffset;

              // Calculate where we need to scroll to
              // Section's current position from top of document + current scroll - desired viewport position
              const desiredViewportPosition = stickyTopPosition + tocHeight + 32;
              const targetPosition = currentScrollY + sectionRect.top - desiredViewportPosition;

              // DEBUG LOGGING
              console.log('=== Mobile Scroll Debug (getBoundingClientRect) ===');
              console.log('Window width:', window.innerWidth);
              console.log('TOC height:', tocHeight);
              console.log('Sticky top position:', stickyTopPosition);
              console.log('Desired viewport position for section:', desiredViewportPosition, 'px');
              console.log('Section getBoundingClientRect().top:', sectionRect.top);
              console.log('Current scroll Y:', currentScrollY);
              console.log('Calculation:', currentScrollY, '+', sectionRect.top, '-', desiredViewportPosition, '=', targetPosition);
              console.log('Target scroll position:', targetPosition);

              window.scrollTo({
                top: Math.max(0, targetPosition),
                behavior: 'smooth'
              });
            } else {
              // Desktop/Tablet: Use offset method
              let offset = 100; // Desktop: header (72px) + small buffer
              if (isTablet) {
                offset = 90; // Tablet: header + small buffer
              }

              const targetPosition = targetSection.offsetTop - offset;

              console.log('Desktop/Tablet scroll to:', targetPosition);

              window.scrollTo({
                top: Math.max(0, targetPosition),
                behavior: 'smooth'
              });
            }
          }
        });
      });

      // References accordion toggle
      if (referencesToggle && referencesSection) {
        referencesToggle.addEventListener('click', function() {
          referencesSection.classList.toggle('is-open');
        });
      }

      // Scroll spy disabled - all TOC links remain in inactive state
      // window.addEventListener('scroll', updateActiveTOCLink);
      // updateActiveTOCLink();
      // setTimeout(updateActiveTOCLink, 100);
    }

    // Initialize on DOM ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initArticleWithTOC);
    } else {
      initArticleWithTOC();
    }
  })();
</script>
