<!--
  templateType: module
  label: Process Steps
  isAvailableForNewContent: true
-->

<style>
  /* Process Steps Module - Uses Brand CSS Variables */

  .process-steps {
    display: flex;
    gap: var(--space-16, 16px);
    width: 100%;
    max-width: var(--content-max-width, 1400px);
    margin: 0 auto;
    padding: 0;
  }

  /* Left Column - Sticky Header */
  .process-steps__header {
    flex: 0 0 calc(50% - 8px);
    display: flex;
    flex-direction: column;
    gap: var(--space-32, 32px);
    padding-top: 0; /* Spacing controlled by DND section container */
    padding-bottom: 0;
  }

  .process-steps__header-sticky {
    position: sticky;
    top: 128px;
    display: flex;
    flex-direction: column;
    gap: var(--space-16, 16px);
  }

  .process-steps__eyebrow {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: var(--space-8, 8px) var(--space-12, 12px);
    border-radius: var(--border-radius-md, 8px);
    background-color: var(--color-gray-900, #F4F4F4);
    font-family: var(--font-body, 'Inter', sans-serif);
    font-weight: var(--font-weight-regular, 450);
    font-size: var(--font-size-body-small, 14px);
    line-height: 1.35;
    color: var(--color-text-secondary, #525252);
    text-align: center;
    text-transform: uppercase;
    white-space: nowrap;
    width: fit-content;
  }

  .process-steps__heading {
    font-family: var(--font-heading, 'Inter', sans-serif);
    font-size: var(--font-size-h2, 3rem);
    font-weight: var(--font-weight-medium, 500);
    line-height: var(--line-height-tight, 1.15);
    color: var(--color-text-primary, #161616);
    margin: 0;
  }

  .process-steps__subheader {
    font-family: var(--font-body, 'Inter', sans-serif);
    font-size: var(--font-size-body-large, 18px);
    font-weight: var(--font-weight-medium, 500);
    line-height: 1.35;
    color: var(--color-text-secondary, #525252);
    margin: 0;
  }

  /* Right Column - Steps */
  .process-steps__content {
    flex: 0 0 calc(50% - 8px);
    display: flex;
    flex-direction: column;
    padding-top: 0; /* Spacing controlled by DND section container */
    padding-bottom: 0; /* Spacing controlled by DND section container */
    position: relative;
  }

  /* Continuous vertical line behind all steps - background line */
  .process-steps__content::before {
    content: '';
    position: absolute;
    left: 32px;
    top: var(--line-top, 0px);
    width: 1px;
    height: var(--line-height, 500px);
    background-color: var(--color-gray-100, #262626);
    transform: translateX(-50%);
    z-index: 0;
  }

  /* Progressive fill line - overlays background line */
  .process-steps__content::after {
    content: '';
    position: absolute;
    left: 32px;
    top: var(--line-top, 0px);
    width: 1px;
    height: var(--progress-line-height, 0px);
    background-color: var(--color-brand-900, #0f2047);
    transform: translateX(-50%);
    z-index: 1;
    transition: height 0.2s ease-out;
  }

  .process-steps__step {
    display: flex;
    gap: var(--space-32, 32px);
    width: 100%;
    margin-bottom: 96px;
  }

  .process-steps__step:last-child {
    margin-bottom: 0;
  }

  .process-steps__step-number-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    flex-shrink: 0;
  }

  .process-steps__step-number {
    width: 64px;
    height: 64px;
    border-radius: 50%;
    border: 1px solid var(--color-gray-100, #262626);
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: var(--font-heading, 'Inter', sans-serif);
    font-size: var(--font-size-h3, 1.75rem) !important;
    font-weight: var(--font-weight-medium, 500);
    line-height: var(--line-height-tight, 1.15);
    color: var(--color-text-primary, #161616);
    background-color: var(--color-bg-primary, #FFFFFF);
    position: relative;
    overflow: hidden;
    transition: all 0.3s ease;
    z-index: 2;
    flex-shrink: 0;
  }

  .process-steps__step-number-text {
    font-size: inherit !important;
  }

  /* Number fill effect - fills from top down */
  .process-steps__step-number::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 0%;
    background-color: var(--color-brand-100, #becfff);
    transition: height 0.6s ease;
    z-index: 0;
  }

  .process-steps__step-number-text {
    position: relative;
    z-index: 1;
    transition: color 0.3s ease;
  }

  .process-steps__step.is-active .process-steps__step-number::before {
    height: 100%;
  }

  .process-steps__step.is-active .process-steps__step-number {
    border-color: var(--color-brand-100, #becfff);
  }

  .process-steps__step.is-active .process-steps__step-number-text {
    color: var(--color-white, #FFFFFF);
  }


  .process-steps__step-details {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: var(--space-8, 8px);
    padding-bottom: 0;
    opacity: 0.4;
    transition: opacity 0.6s ease;
  }

  .process-steps__step.is-active .process-steps__step-details {
    opacity: 1;
  }

  .process-steps__step-title {
    font-family: var(--font-heading, 'Inter', sans-serif);
    font-size: var(--font-size-h3, 1.75rem);
    font-weight: var(--font-weight-medium, 500);
    line-height: var(--line-height-tight, 1.15);
    color: var(--color-text-primary, #161616);
    margin: 0;
  }

  .process-steps__step-description {
    font-family: var(--font-body, 'Inter', sans-serif);
    font-size: var(--font-size-body, 1rem);
    font-weight: var(--font-weight-regular, 450);
    line-height: var(--line-height-normal, 1.5);
    color: var(--color-text-secondary, #525252);
    margin: 0;
  }

  .process-steps__step-description p {
    margin: 0 0 var(--space-12, 12px) 0;
  }

  .process-steps__step-description p:last-child {
    margin-bottom: 0;
  }

  /* Mobile Layout (767px and below) */
  @media (max-width: 767px) {
    .process-steps {
      flex-direction: column;
      gap: var(--space-32, 32px);
      padding: 0; /* Spacing controlled by DND section container */
      position: relative;
    }

    .process-steps__header {
      flex: none;
      padding: 0;
      position: -webkit-sticky;
      position: sticky;
      top: 72px;
      align-self: flex-start;
      width: 100%;
      background-color: var(--color-bg-primary, #FFFFFF);
      padding-bottom: var(--space-16, 16px);
      z-index: 10;
      margin-bottom: var(--space-32, 32px);
    }

    .process-steps__header-sticky {
      position: static;
      padding: 0;
    }

    .process-steps__content {
      flex: none;
      padding-top: 0;
      padding-bottom: 0;
    }

    .process-steps__content::before {
      left: 24px;
    }

    .process-steps__content::after {
      left: 24px;
    }

    .process-steps__step {
      margin-bottom: 64px;
    }

    .process-steps__step-number {
      width: 48px;
      height: 48px;
    }
  }

  /* Tablet Layout (768px-1023px) */
  @media (max-width: 1023px) and (min-width: 768px) {
    .process-steps__header {
      padding-top: 0; /* Spacing controlled by DND section container */
    }

    .process-steps__header-sticky {
      top: 64px;
    }

    .process-steps__content {
      padding-top: 0; /* Spacing controlled by DND section container */
      padding-bottom: 0; /* Spacing controlled by DND section container */
    }

    .process-steps__step {
      margin-bottom: 80px;
    }
  }
</style>

<div class="process-steps">
  <!-- Left Column - Sticky Header -->
  <div class="process-steps__header">
    <div class="process-steps__header-sticky">
      {% if module.eyebrow_text %}
        <div class="process-steps__eyebrow">{{ module.eyebrow_text }}</div>
      {% endif %}
      {% if module.heading_text %}
        <h2 class="process-steps__heading">{{ module.heading_text }}</h2>
      {% endif %}
      {% if module.subheader_text %}
        <p class="process-steps__subheader">{{ module.subheader_text }}</p>
      {% endif %}
    </div>
  </div>

  <!-- Right Column - Steps -->
  <div class="process-steps__content" data-step-count="{{ module.steps|length }}">
    {% for step in module.steps %}
      <div class="process-steps__step" data-step-index="{{ loop.index0 }}">
        <div class="process-steps__step-number-container">
          <div class="process-steps__step-number">
            <span class="process-steps__step-number-text">{{ loop.index }}</span>
          </div>
          {% if not loop.last %}
            <div class="process-steps__step-line"></div>
          {% endif %}
        </div>
        <div class="process-steps__step-details">
          {% if step.step_title %}
            <h3 class="process-steps__step-title">{{ step.step_title }}</h3>
          {% endif %}
          {% if step.step_description %}
            <div class="process-steps__step-description">{{ step.step_description }}</div>
          {% endif %}
        </div>
      </div>
    {% endfor %}
  </div>
</div>

<script>
  (function() {
    function initProcessSteps() {
      const steps = document.querySelectorAll('.process-steps__step');
      if (steps.length === 0) return;

      // Create a style element for dynamic pseudo-element updates
      const styleEl = document.createElement('style');
      styleEl.id = 'process-steps-dynamic-styles';
      document.head.appendChild(styleEl);

      // Set the line starting position and height dynamically
      function setLinePositionAndHeight() {
        const content = document.querySelector('.process-steps__content');
        if (!content || steps.length === 0) return;

        const firstStep = steps[0];
        const firstCircle = firstStep.querySelector('.process-steps__step-number');
        const lastStep = steps[steps.length - 1];
        const lastCircle = lastStep.querySelector('.process-steps__step-number');

        if (!firstCircle || !lastCircle) return;

        const contentRect = content.getBoundingClientRect();
        const firstCircleRect = firstCircle.getBoundingClientRect();
        const lastCircleRect = lastCircle.getBoundingClientRect();

        // Calculate line starting position (center of first circle)
        const circleRadius = firstCircleRect.height / 2;
        const lineTop = (firstCircleRect.top - contentRect.top) + circleRadius;
        content.style.setProperty('--line-top', lineTop + 'px');

        // Calculate line height (from center of first circle to center of last circle)
        // Both positions must be relative to content container
        const lastCircleCenter = (lastCircleRect.top - contentRect.top) + (lastCircleRect.height / 2);
        const lineHeight = lastCircleCenter - lineTop;
        content.style.setProperty('--line-height', lineHeight + 'px');

        // Store line top for use in scroll calculations
        content.dataset.lineTop = lineTop;
      }

      function checkStepActivation() {
        const content = document.querySelector('.process-steps__content');
        if (!content) return;

        const isMobile = window.innerWidth <= 767;
        const isTablet = window.innerWidth >= 768 && window.innerWidth <= 1023;

        // Trigger point: earlier activation so circles fill before user finishes reading
        // Mobile: account for sticky header (fixed nav 72px + sticky process header + spacing)
        let triggerPoint = 250; // Default for desktop
        if (isMobile) {
          const stickyHeader = document.querySelector('.process-steps__header');
          const stickyHeaderHeight = stickyHeader ? stickyHeader.offsetHeight : 0;
          const fixedNavHeight = 72; // Fixed header height
          // Trigger when circle reaches just below the sticky header
          triggerPoint = fixedNavHeight + stickyHeaderHeight + 32;
        }

        let maxActivatedIndex = -1;
        let progressLineHeight = 0;

        const contentRect = content.getBoundingClientRect();
        const lineTopOffset = parseFloat(content.dataset.lineTop) || 0;

        // Progressive activation: activate all steps up to and including the one at trigger point
        steps.forEach((step, index) => {
          const circle = step.querySelector('.process-steps__step-number');
          if (!circle) return;

          const circleRect = circle.getBoundingClientRect();
          const circleTop = circleRect.top;
          const circleBottom = circleRect.bottom;

          // Activate this step and all previous steps when circle top reaches trigger
          if (circleTop <= triggerPoint) {
            maxActivatedIndex = index;
          }
        });

        // Apply activation state to all steps up to maxActivatedIndex
        steps.forEach((step, index) => {
          if (index <= maxActivatedIndex) {
            step.classList.add('is-active');
          } else {
            step.classList.remove('is-active');
          }
        });

        // Calculate progressive line fill
        // Fill to the bottom of the last activated circle, or partially through current viewport
        if (maxActivatedIndex >= 0) {
          const lastActivatedStep = steps[maxActivatedIndex];
          const lastActivatedCircle = lastActivatedStep.querySelector('.process-steps__step-number');

          if (lastActivatedCircle) {
            const lastCircleRect = lastActivatedCircle.getBoundingClientRect();
            const lastCircleBottom = lastCircleRect.bottom;

            // Fill line to bottom of last activated circle
            progressLineHeight = lastCircleBottom - contentRect.top - lineTopOffset;

            // If there's a next step, extend line progressively toward it
            if (maxActivatedIndex + 1 < steps.length) {
              const nextStep = steps[maxActivatedIndex + 1];
              const nextCircle = nextStep.querySelector('.process-steps__step-number');

              if (nextCircle) {
                const nextCircleRect = nextCircle.getBoundingClientRect();
                const nextCircleTop = nextCircleRect.top;

                // Progressive fill between last activated circle and next circle
                // Add visible portion (from trigger point to below viewport a bit)
                const visibleProgressStart = triggerPoint;
                const visibleProgressEnd = triggerPoint + 200; // Extend 200px below trigger

                if (nextCircleTop > visibleProgressStart && nextCircleTop < visibleProgressEnd) {
                  // Calculate how much of the gap to fill based on next circle position
                  const gapProgress = (visibleProgressEnd - nextCircleTop) / (visibleProgressEnd - visibleProgressStart);
                  const additionalFill = (nextCircleTop - lastCircleBottom) * gapProgress;
                  progressLineHeight += Math.max(0, additionalFill);
                }
              }
            }
          }
        }

        // Update progressive line fill by injecting CSS rule
        const progressHeight = Math.max(0, progressLineHeight);
        const styleEl = document.getElementById('process-steps-dynamic-styles');
        if (styleEl) {
          styleEl.textContent = `
            .process-steps__content::after {
              height: ${progressHeight}px !important;
            }
          `;
        }
      }

      // Set line position and height
      setLinePositionAndHeight();
      window.addEventListener('resize', setLinePositionAndHeight);

      // Run on scroll
      window.addEventListener('scroll', checkStepActivation);

      // Run on load
      checkStepActivation();

      // Run after a short delay to ensure layout is settled
      setTimeout(checkStepActivation, 100);
      setTimeout(setLinePositionAndHeight, 100);
    }

    // Initialize on DOM ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initProcessSteps);
    } else {
      initProcessSteps();
    }
  })();
</script>
